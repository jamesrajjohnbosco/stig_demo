name: GKE Deployment Pipeline

on:
  push:
    branches:
      - main

# Define permissions required for Workload Identity Federation (WIF)
permissions:
  contents: 'read'

env:
  # Constants (referencing the Artifact Registry setup)
  ARTIFACT_REPO: app-images
  IMAGE_NAME: flask-stig-demo
  K8S_DEPLOYMENT_FILE: k8s/deployment.yaml
  IMAGE_TAG: ${{ github.sha }}
  # Define the REGISTRY_LOCATION using the GKE_ZONE secret
  REGISTRY_LOCATION: ${{ secrets.GKE_ZONE }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- 1. AUTHENTICATION (Using Service Account Key Fallback Only) ---
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          # Use the Service Account Key File (Requires creating a GitHub Secret named GCP_CREDENTIALS)
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      # --- 2. Setup gcloud SDK ---
      # This sets PROJECT_ID as a global variable accessible by all subsequent steps
      - name: Set up GCloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          
      # --- 3. SECURITY (STIG Compliance Demo) ---
      - name: ðŸ›¡ï¸ STIG Compliance Check (Conceptual Demo)
        id: security_check
        run: |
          echo "--- Running Simulated STIG/CIS Compliance Scan ---"
          echo "Simulating check passed."
          echo "status=PASSED" >> $GITHUB_OUTPUT
        shell: bash

      - name: Fail if STIG Compliance Check Failed
        if: steps.security_check.outputs.status != 'PASSED'
        run: |
          echo "Security compliance check failed. Deployment blocked."
          exit 1
      
      # --- 4. BUILD & PUSH CONTAINER IMAGE (Consolidated Logic) ---
      - name: Build and Push Docker Image to Artifact Registry
        run: |
          # Define full URI using the explicit location defined in env
          IMAGE_URI="${{ env.REGISTRY_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}"
          TAGGED_IMAGE_URI="${IMAGE_URI}:${{ env.IMAGE_TAG }}"

          echo "Authenticating Docker for registry: ${{ env.REGISTRY_LOCATION }}-docker.pkg.dev"
          
          # Configure Docker to use gcloud credentials (needed to push to AR)
          # NOTE: Using the REGISTRY_LOCATION env variable defined above
          gcloud auth configure-docker "${{ env.REGISTRY_LOCATION }}-docker.pkg.dev" --quiet

          echo "Building image: ${TAGGED_IMAGE_URI}"
          # Build the image (using Dockerfile in root)
          docker build -t $TAGGED_IMAGE_URI .

          echo "Pushing image..."
          # Push the image to Artifact Registry
          docker push $TAGGED_IMAGE_URI
        shell: bash

      # --- 5. DEPLOY TO GKE ---
      - name: Set up Kubectl and Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_ZONE }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Deploy to GKE
        run: |
          # Define the full image tag for manifest replacement
          FULL_IMAGE_TAG="${{ env.REGISTRY_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          
          # Substitute the GKE_IMAGE_TAG placeholder in the manifest
          sed -i "s@GKE_IMAGE_TAG@${FULL_IMAGE_TAG}@g" ${{ env.K8S_DEPLOYMENT_FILE }}
          sed -i "s@value: \"1.0\"@value: \"${{ env.IMAGE_TAG }}\"@g" ${{ env.K8S_DEPLOYMENT_FILE }}

          # Apply the updated Kubernetes manifest
          kubectl apply -f ${{ env.K8S_DEPLOYMENT_FILE }}

      - name: Verify Deployment Rollout
        run: |
          kubectl rollout status deployment/flask-stig-demo --timeout=5m
